{% extends "index.html" %}

{% load static %}
{% block navbar %} {% endblock navbar %}

{% block container %}
{% endblock container %}

{% block auth %}
<div class="fixed inset-0 z-30 flex items-center justify-center overflow-auto bg-black bg-opacity-75 transition-opacity"
    x-show="showModal" x-transition:enter="transition ease-out duration-300" id="modal"
    x-transition:enter-start="transform opacity-0"
    x-transition:enter-end="transform opacity-100"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="transform opacity-100"
    x-transition:leave-end="transform opacity-0" style="display: none;">
    <!-- Modal inner -->
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen"
        aria-hidden="true">&#8203;</span>
    <div class="inline-block align-bottom bg-white rounded-lg text-left shadow-xl transform transition-all sm:my-8 sm:align-middle"
        @click.away="showModal = false"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="transform opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="transform opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave-end="transform opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4" style="text-align: center;width: 648px">
            <canvas id="canvas" width="600" height="600"></canvas>
            <p id="loading-text" class="text-base text-center font-medium mb-2 mt-2" style="font-size: 25px">Cargando...</p>
            <p id="recommendations-text" class="text-base text-center font-medium mb-2 mt-2" style="font-size: 25px"></p>
            <button type="button" id="accept-button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" disabled>Aceptar</button>
        </div>
    </div>
</div>
<div class="center">
    <video id="video" width="1200" autoplay></video>
    <button type="button" id="start-camera" class="center mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Start Camera</button>
    <div style="display: none; text-align: center" id="worker-controllers">
        <label for="dni" class="block text-base font-normal text-gray-600 mt-3">DNI</label>
        <input type="text" name="dni" id="dni" class="mb-2 mt-1 w-full text-sm border border-gray-300 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-indigo-500 py-1.5 px-3 shadow rounded-full sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm"/>
        <button disabled style="top: 105% !important;" type="button" id="take-photo" class="center mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Tomar foto</button>    
    </div>
</div>
<script>
    let camera_button = document.querySelector("#start-camera");
    let video = document.querySelector("#video");
    let take_photo_button = document.querySelector("#take-photo");
    let accept_button = document.querySelector("#accept-button");
    let canvas = document.querySelector("#canvas");
    let modal = document.querySelector("#modal");
    let loadingText = document.querySelector("#loading-text");
    let recommendationsText = document.querySelector("#recommendations-text");
    let worker_controllers = document.querySelector("#worker-controllers");
    let dni = document.querySelector("#dni");

    function processResponse(response) {
        response = JSON.parse(response)

        if (response.success) {
            loadingText.innerHTML = "Verificaci√≥n exitosa"
            recommendationsText.innerHTML = "La mascarilla se encuentra correctamente puesta"
        } else {
            loadingText.innerHTML = "Se encontraron problemas"
            recommendationsText.innerHTML = response.recommendation
        }

        accept_button.disabled = false
        console.log(response);
    }

    function sendData(image) {
        var xhr = new XMLHttpRequest();

        var form_data = new FormData();
        form_data.append('image', image);
        form_data.append('dni', dni.value);

        xhr.open("POST", '{% url 'incidents:camera_request' id=camera_id %}', true);
        xhr.setRequestHeader('x-csrf-token', '{{ csrf_token  }}');
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                processResponse(xhr.response);
            }
        }
        xhr.send(form_data);
    }

    accept_button.addEventListener("click", async function() {
        this.disabled = true
        dni.value = '';
        video.style.display = "";
        modal.style.display = "none";
    });

    camera_button.addEventListener("click", async function() {
        let stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = stream;
        worker_controllers.style.display = "block";
        this.remove()
    });

    take_photo_button.addEventListener('click', function() {
        loadingText.innerHTML = "Cargando..."
        recommendationsText.innerHTML = ""

        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        let image_data_url = canvas.toDataURL('image/jpeg');

        video.style.display = "none";
        modal.style.display = "";

        sendData(image_data_url);
    });

    dni.addEventListener('input', function () {
        if (this.value) {
            take_photo_button.disabled = false
        } else {
            take_photo_button.disabled = true
        }
    })
</script>
{% endblock auth %}